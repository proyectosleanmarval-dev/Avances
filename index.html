<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Días de Atraso por Proyecto</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background: #f7f9fc;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: white;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #1f2937;
      color: white;
    }

    td.proyecto {
      text-align: left;
      font-weight: bold;
      background: #f3f4f6;
    }

    td.atraso {
      background: #ffe5e5;
      color: #b30000;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h1>Días de Atraso por Proyecto y Mes</h1>
<div id="estado">Cargando datos...</div>

<table id="tabla" style="display:none;">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
async function cargarDatos() {
  try {
    const response = await fetch('data/consolidado.json');
    if (!response.ok) throw new Error("No se pudo cargar el JSON");

    const data = await response.json();

    if (!Array.isArray(data) || data.length === 0) {
      document.getElementById("estado").innerText = "No hay datos disponibles.";
      return;
    }

    // Agrupar datos
    const proyectos = {};
    const mesesSet = new Set();

    data.forEach(d => {

      const proyecto = d.Proyecto;

      // Extraer mes desde nombre archivo (Enero.xlsx -> Enero)
      const mes = d.__archivo_origen.replace(".xlsx", "");

      mesesSet.add(mes);

      // Calcular días de atraso
      const base = new Date(d.Fecha_Base);
      const proyectada = new Date(d.Fecha_Proyectada);

      const diasAtraso = Math.round(
        (proyectada - base) / (1000 * 60 * 60 * 24)
      );

      if (!proyectos[proyecto]) {
        proyectos[proyecto] = {};
      }

      proyectos[proyecto][mes] = diasAtraso;
    });

    const meses = Array.from(mesesSet).sort();

    const thead = document.querySelector("#tabla thead");
    const tbody = document.querySelector("#tabla tbody");

    // Header
    let header = "<tr><th>Proyecto</th>";
    meses.forEach(m => header += `<th>${m}</th>`);
    header += "</tr>";
    thead.innerHTML = header;

    // Body
    let bodyHTML = "";

    for (const proyecto in proyectos) {
      bodyHTML += `<tr><td class="proyecto">${proyecto}</td>`;

      meses.forEach(m => {
        const valor = proyectos[proyecto][m] ?? 0;
        const clase = valor > 0 ? "atraso" : "";
        bodyHTML += `<td class="${clase}">${valor}</td>`;
      });

      bodyHTML += "</tr>";
    }

    tbody.innerHTML = bodyHTML;

    document.getElementById("estado").style.display = "none";
    document.getElementById("tabla").style.display = "table";

  } catch (error) {
    document.getElementById("estado").innerText =
      "Error cargando datos: " + error.message;
  }
}

cargarDatos();
</script>

</body>
</html>
